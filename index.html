<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Amplify + Cognito Hosted UI</title>
    <script type="importmap">
    {
        "imports": {
            "aws-amplify": "https://cdn.jsdelivr.net/npm/aws-amplify@6.0.0/+esm",
            "aws-amplify/auth": "https://cdn.jsdelivr.net/npm/aws-amplify@6.0.0/auth/+esm"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
            text-align: center;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        h1 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .btn {
            width: 100%;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9ff;
        }

        .message {
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            font-size: 0.9rem;
            text-align: left;
        }

        .info {
            background: #eef;
            color: #33c;
            border: 1px solid #ccf;
        }

        .success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .user-info {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            text-align: left;
        }

        .user-info h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .user-info p {
            color: #555;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .user-info strong {
            color: #333;
        }

        .welcome-message {
            background: #e8f5e9;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            border: 2px solid #4caf50;
        }

        .welcome-message p {
            color: #2e7d32;
            margin: 0.75rem 0;
            font-size: 1rem;
        }

        .welcome-message strong {
            font-weight: 700;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .config-section {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            text-align: left;
            font-size: 0.85rem;
        }

        .config-section code {
            background: #fff;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: monospace;
            color: #667eea;
        }

        .config-section ol {
            margin: 1rem 0 1rem 1.5rem;
        }

        .config-section li {
            margin: 0.5rem 0;
            color: #555;
        }

        @media (max-width: 768px) {
            .container {
                padding: 2rem;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginScreen">
            <div class="logo">ğŸ”</div>
            <h1>AWS Cognito</h1>
            <p class="subtitle">Hosted UIã‚’ä½¿ç”¨ã—ãŸèªè¨¼</p>
            
            <div id="message"></div>
            
            <button class="btn" onclick="handleHostedUILogin()">
                Cognitoã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            
            <div class="config-section">
                <strong>âš™ï¸ è¨­å®šãŒå¿…è¦ã§ã™</strong>
                <ol>
                    <li>Cognitoãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®<code>ãƒ‰ãƒ¡ã‚¤ãƒ³</code>ã‚’è¨­å®š</li>
                    <li>ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®<code>ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URL</code>ã‚’è¿½åŠ <br>
                    <code>http://localhost:8080/</code> ã¾ãŸã¯<br>
                    <code>https://your-app.amplifyapp.com/</code></li>
                    <li>ä¸‹è¨˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®è¨­å®šå€¤ã‚’æ›´æ–°ã—ã¦ãã ã•ã„</li>
                </ol>
            </div>
        </div>

        <div id="welcomeScreen" class="hidden">
            <div class="logo">ğŸ‰</div>
            <h1>ãƒ­ã‚°ã‚¤ãƒ³ã§ããŸã‚ˆï¼</h1>
            <p class="subtitle">èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ</p>
            
            <div class="user-info">
                <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
                <p id="userInfo">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div class="welcome-message">
                <p>âœ… ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: <strong style="color: #3c3;">èªè¨¼æ¸ˆã¿</strong></p>
                <p>ğŸ• ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»: <span id="loginTime"></span></p>
            </div>
            
            <button class="btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <script type="module">
        import { Amplify } from 'aws-amplify';
        import { signInWithRedirect, signOut, getCurrentUser, fetchUserAttributes } from 'aws-amplify/auth';

        // ========================================
        // âš™ï¸ ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„
        // ========================================
        const amplifyConfig = {
            Auth: {
                Cognito: {
                    userPoolId: 'ap-northeast-1_f3sFcAFGS',              // ä¾‹: ap-northeast-1_abcdefghi
                    userPoolClientId: '1h1evf4409fl7q06j4ubr19176',           // ä¾‹: 1234567890abcdefghij
                    loginWith: {
                        oauth: {
                            domain: 'https://ap-northeast-1f3sfcafgs.auth.ap-northeast-1.amazoncognito.com',        // ä¾‹: myapp.auth.ap-northeast-1.amazoncognito.com
                            scopes: ['openid', 'email', 'profile'],
                            redirectSignIn: ['https://main.d10q7es53y3mgm.amplifyapp.com/'], // é–‹ç™ºç’°å¢ƒ
                            redirectSignOut: ['https://main.d10q7es53y3mgm.amplifyapp.com/'], // é–‹ç™ºç’°å¢ƒ
                            responseType: 'code'
                        }
                    }
                }
            }
        };
        // ========================================

        let currentUser = null;

        // AmplifyåˆæœŸåŒ–
        try {
            Amplify.configure(amplifyConfig);
            console.log('âœ… Amplifyè¨­å®šå®Œäº†');
        } catch (error) {
            console.error('âŒ Amplifyè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            showMessage('âŒ Amplifyè¨­å®šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type = 'info') {
            const el = document.getElementById('message');
            el.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // Hosted UIãƒ­ã‚°ã‚¤ãƒ³
        window.handleHostedUILogin = async function() {
            // è¨­å®šãƒã‚§ãƒƒã‚¯
            if (amplifyConfig.Auth.Cognito.userPoolId === 'YOUR_USER_POOL_ID') {
                showMessage('âš ï¸ è¨­å®šå€¤ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®amplifyConfigã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            try {
                console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹...');
                await signInWithRedirect();
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        };

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        window.handleLogout = async function() {
            try {
                console.log('ğŸ‘‹ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–‹å§‹...');
                await signOut();
                currentUser = null;
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                showMessage('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
        function displayUserInfo(attributes) {
            const userInfoEl = document.getElementById('userInfo');
            let infoHTML = '';
            
            if (attributes.email) {
                infoHTML += `<p><strong>Email:</strong> ${attributes.email}</p>`;
            }
            if (attributes.sub) {
                infoHTML += `<p><strong>User ID:</strong> ${attributes.sub}</p>`;
            }
            if (attributes.email_verified !== undefined) {
                infoHTML += `<p><strong>ãƒ¡ãƒ¼ãƒ«ç¢ºèª:</strong> ${attributes.email_verified ? 'âœ… æ¸ˆ' : 'âŒ æœª'}</p>`;
            }
            if (attributes.name) {
                infoHTML += `<p><strong>åå‰:</strong> ${attributes.name}</p>`;
            }
            
            userInfoEl.innerHTML = infoHTML || '<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’è¡¨ç¤º
            const now = new Date();
            document.getElementById('loginTime').textContent = now.toLocaleString('ja-JP');
        }

        // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkAuthState() {
            try {
                console.log('ğŸ” èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ä¸­...');
                
                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                currentUser = await getCurrentUser();
                console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ:', currentUser);
                
                if (currentUser) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚’å–å¾—
                    const attributes = await fetchUserAttributes();
                    console.log('ğŸ“‹ å±æ€§å–å¾—æˆåŠŸ:', attributes);
                    
                    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’è¡¨ç¤º
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    displayUserInfo(attributes);
                }
            } catch (error) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ
                console.log('â„¹ï¸ æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹:', error.message);
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('welcomeScreen').classList.add('hidden');
            }
        }

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†ï¼ˆOAuth ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œï¼‰
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('code')) {
                console.log('ğŸ”„ OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œå‡º');
                showMessage('ğŸ”„ èªè¨¼å‡¦ç†ä¸­...', 'info');
                
                // URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    checkAuthState();
                }, 1500);
            } else {
                checkAuthState();
            }
        }

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•');
            handleOAuthCallback();
        });
    </script>
</body>
</html>